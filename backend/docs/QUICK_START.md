# OpenAI Prompt 日志 - 快速开始

## 📋 功能说明

系统会自动记录 **is_admin=true** 用户与 OpenAI 的所有对话，包括：
- ✅ 完整的 system prompt（基础指令 + 治疗师个性化指令 + 用户上下文）
- ✅ 完整的对话历史
- ✅ Token 使用情况（包括缓存 tokens）

## 🚀 一分钟上手

### 1. 设置 Admin 用户

```sql
-- 连接到数据库
psql -U ai_user -d ai_therapy

-- 给某个用户开启日志记录
UPDATE users SET is_admin = true WHERE id = 1;
```

### 2. 进行对话

让该用户进行正常对话，系统会自动记录所有 prompts。

### 3. 查看日志

**方式 1: 双击 HTML 文件（最简单）** ⭐

```bash
# macOS
open logs/prompts/latest.html

# Windows
start logs/prompts/latest.html

# Linux
xdg-open logs/prompts/latest.html
```

或者直接在文件管理器中找到 `logs/prompts/latest.html`，双击打开。

**特点**:
- 每次记录日志后自动更新
- 刷新页面即可看到最新日志
- 支持搜索、展开/折叠
- 显示 Token 使用和缓存率统计

---

**方式 2: 命令行查看**

```bash
# 查看今天的日志
python scripts/view_prompts.py --today

# 查看某个用户的日志
python scripts/view_prompts.py --user-id 1

# 查看最近 10 条
python scripts/view_prompts.py --last 10 --show-full
```

---

## 🎯 查看示例

### HTML 界面示例

打开 `logs/prompts/latest.html` 后，你会看到：

```
╔══════════════════════════════════════════════════════════╗
║  🔍 OpenAI Prompt 日志 - 实时查看                          ║
║  最后更新: 2025-12-13 16:35:20 | 自动刷新页面查看最新日志     ║
╚══════════════════════════════════════════════════════════╝

┌─────────────┬─────────────┬─────────┬─────────┬─────────────┐
│ 总请求数: 5  │ 总响应数: 5  │ 用户数: 2│ 总Tokens│ 平均缓存率   │
│             │             │         │ 8,450   │   68.5%     │
└─────────────┴─────────────┴─────────┴─────────┴─────────────┘

[搜索框]  [搜索]  [刷新]

┌──────────────────────────────────────────────────────────┐
│ 🔵 REQUEST  2025-12-13T16:30:00  User: 1  Session: abc...│
│                                                      [▼]  │
├──────────────────────────────────────────────────────────┤
│ SYSTEM                                                   │
│ 你是一名经验丰富、稳定、温和且具有深度洞察力的心理咨询师...     │
│                                                          │
│ USER                                                     │
│ 我最近感觉很焦虑，不知道该怎么办                             │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│ 🟢 RESPONSE  2025-12-13T16:30:05  User: 1  Session: abc..│
│                                                      [▼]  │
├──────────────────────────────────────────────────────────┤
│ ASSISTANT                                                │
│ 我能感受到你的焦虑。能和我多说说是什么让你感到焦虑吗？...    │
│                                                          │
│ Token 使用:                                              │
│ 输入: 1,450  输出: 180  总计: 1,630  缓存: 1,200 (82.8%)  │
└──────────────────────────────────────────────────────────┘
```

### 日志内容示例

点击展开后，可以看到：

**Request 日志**:
- 完整的 system prompt（包括基础指令、治疗师指令、用户上下文）
- 历史对话（最近 20 轮）
- 当前用户输入
- 请求参数（temperature, max_tokens 等）

**Response 日志**:
- AI 回复内容
- Token 使用详情：
  - 输入 tokens
  - 输出 tokens
  - 缓存 tokens（便宜 50%）
  - 缓存率百分比

---

## 💡 常见场景

### 场景 1: 查看某次对话的完整 prompt

1. 打开 `logs/prompts/latest.html`
2. 在搜索框输入会话 ID 或用户 ID
3. 点击搜索
4. 点击展开查看完整内容

### 场景 2: 分析缓存效率

HTML 页面顶部会显示平均缓存率，例如：

```
平均缓存率: 68.5%
```

这意味着平均有 68.5% 的输入 tokens 来自缓存，成本节省约 34%。

### 场景 3: 导出某个用户的所有日志

```bash
# 导出为独立的 HTML 文件
python scripts/export_html.py --user-id 1 --output user_1_logs.html

# 导出为 JSON 进行数据分析
python scripts/view_prompts.py --user-id 1 --export user_1.json
```

---

## 🔍 Token 缓存详解

### 什么是 Token 缓存？

OpenAI 会自动缓存相似的 prompt 前缀（主要是 system prompt）：

**首次请求**:
```
输入: 1,500 tokens × $0.15/1M = $0.225
```

**后续请求（缓存命中）**:
```
缓存: 1,200 tokens × $0.075/1M = $0.090
新内容: 300 tokens × $0.15/1M = $0.045
总计: $0.135（节省 40%）
```

### 如何提高缓存率？

1. **保持 system prompt 稳定** - 不要频繁修改基础指令
2. **用户上下文结构化** - 保持格式一致
3. **5 分钟内的请求** - 缓存有效期约 5 分钟

### 查看缓存统计

HTML 页面会自动显示每次对话的缓存情况：

```
输入: 1,450  缓存: 1,200 (82.8%)
```

---

## ⚠️ 注意事项

1. **隐私保护**:
   - 仅 admin 用户的对话会被记录
   - 日志包含完整对话内容，务必保护访问权限
   - 已在 `.gitignore` 中排除日志文件

2. **存储空间**:
   - 每条日志约 2-5 KB
   - 建议定期归档（见 `logs/README.md`）

3. **性能影响**:
   - 后台异步更新 HTML，不阻塞主线程
   - 对非 admin 用户完全无影响

---

## 📚 更多信息

- 完整文档: `docs/OPENAI_LOGGING.md`
- 日志说明: `logs/README.md`
- 查看工具: `scripts/view_prompts.py --help`
- 导出工具: `scripts/export_html.py --help`
