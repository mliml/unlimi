# éƒ¨ç½²æŒ‡å—

æœ¬é¡¹ç›®æä¾›ä¸¤ä¸ªéƒ¨ç½²è„šæœ¬ï¼Œåˆ†åˆ«ç”¨äºä¸åŒåœºæ™¯ã€‚

---

## ğŸ“‹ ä¸¤ä¸ªéƒ¨ç½²è„šæœ¬å¯¹æ¯”

| ç‰¹æ€§ | `deploy.sh` | `redeploy.sh` |
|------|-------------|---------------|
| **æ•°æ®åº“æ•°æ®** | âœ… ä¿ç•™ | âŒ æ¸…ç©º |
| **ä½¿ç”¨åœºæ™¯** | æ—¥å¸¸æ›´æ–°ã€ç”Ÿäº§ç¯å¢ƒ | å®Œå…¨é‡å»ºã€ä¿®å¤é—®é¢˜ |
| **é€‚ç”¨æ—¶æœº** | æ›´æ–°ä»£ç ã€ä¿®å¤ bug | æ•°æ®åº“ç»“æ„å˜æ›´ã€æ¸…ç©ºæµ‹è¯•æ•°æ® |
| **é£é™©** | ä½ | é«˜ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰ |

---

## ğŸš€ deploy.sh - å¸¸è§„éƒ¨ç½²ï¼ˆä¿ç•™æ•°æ®ï¼‰

### é€‚ç”¨åœºæ™¯
- âœ… æ—¥å¸¸ä»£ç æ›´æ–°
- âœ… ä¿®å¤ bug åéƒ¨ç½²
- âœ… æ·»åŠ æ–°åŠŸèƒ½
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- âœ… æœ‰ç”¨æˆ·æ•°æ®æ—¶

### æ‰§è¡Œæ­¥éª¤
```bash
./deploy.sh
```

### å…·ä½“æ“ä½œ
1. æ‹‰å–æœ€æ–°ä»£ç 
2. éªŒè¯é…ç½®
3. é‡æ–°æ„å»º Docker é•œåƒ
4. é‡å¯å®¹å™¨
5. **ä¿ç•™æ•°æ®åº“æ•°æ®**
6. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœæœ‰æ–°çš„è¿ç§»æ–‡ä»¶ï¼‰

### âš ï¸ æ³¨æ„
- æ•°æ®åº“è¿ç§»ä¼šè‡ªåŠ¨åº”ç”¨ï¼ˆ`alembic upgrade head`ï¼‰
- åªä¼šæ·»åŠ æ–°çš„è¡¨/å­—æ®µï¼Œä¸ä¼šåˆ é™¤ç°æœ‰æ•°æ®

---

## ğŸ”„ redeploy.sh - å®Œå…¨é‡å»ºï¼ˆæ¸…ç©ºæ•°æ®ï¼‰

### é€‚ç”¨åœºæ™¯
- âš ï¸ å¼€å‘/æµ‹è¯•ç¯å¢ƒ
- âš ï¸ æ•°æ®åº“è¡¨ç»“æ„ä¸¥é‡é”™è¯¯éœ€è¦é‡å»º
- âš ï¸ æƒ³æ¸…ç©ºæµ‹è¯•æ•°æ®é‡æ–°å¼€å§‹
- âŒ **ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ**

### æ‰§è¡Œæ­¥éª¤
```bash
./redeploy.sh
```

### å…·ä½“æ“ä½œ
1. åœæ­¢æ‰€æœ‰å®¹å™¨
2. **åˆ é™¤æ•°æ®åº“ volumeï¼ˆæ‰€æœ‰æ•°æ®ä¸¢å¤±ï¼‰**
3. æ‹‰å–æœ€æ–°ä»£ç 
4. éªŒè¯é…ç½®
5. é‡æ–°æ„å»º Docker é•œåƒ
6. å¯åŠ¨å®¹å™¨
7. ä»é›¶åˆ›å»ºæ•°æ®åº“ç»“æ„
8. åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼ˆæ²»ç–—å¸ˆã€é‚€è¯·ç ï¼‰

### âš ï¸ è­¦å‘Š
**æ‰€æœ‰æ•°æ®åº“æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼ŒåŒ…æ‹¬ï¼š**
- æ‰€æœ‰ç”¨æˆ·è´¦å·
- æ‰€æœ‰ä¼šè¯è®°å½•
- æ‰€æœ‰å’¨è¯¢å†å²
- ç®¡ç†å‘˜è´¦å·
- é‚€è¯·ç ä½¿ç”¨è®°å½•

---

## ğŸ“ ä½¿ç”¨å»ºè®®

### å¼€å‘é˜¶æ®µ
```bash
# é¢‘ç¹ä¿®æ”¹è¡¨ç»“æ„æ—¶ï¼Œä½¿ç”¨ redeploy.sh
./redeploy.sh

# æ™®é€šä»£ç æ›´æ–°ï¼Œä½¿ç”¨ deploy.sh
./deploy.sh
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# æ°¸è¿œä½¿ç”¨ deploy.sh
./deploy.sh

# é™¤éè¦æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®é‡æ–°å¼€å§‹ï¼Œå¦åˆ™ä¸è¦ç”¨ redeploy.sh
```

---

## ğŸ”§ é¦–æ¬¡éƒ¨ç½²

**ç¬¬ä¸€æ¬¡éƒ¨ç½²é¡¹ç›®æ—¶ï¼š**

```bash
# 1. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env  # å¡«å†™çœŸå®çš„é…ç½®

# 2. å®Œå…¨éƒ¨ç½²ï¼ˆæ­¤æ—¶æ²¡æœ‰æ•°æ®ï¼Œå¯ä»¥ç”¨ redeploy.shï¼‰
./redeploy.sh

# 3. åˆ›å»ºç®¡ç†å‘˜è´¦å·
# åœ¨æµè§ˆå™¨è®¿é—® http://your-server-ip
# ä½¿ç”¨é‚€è¯·ç  WuSY_940315 æ³¨å†Œç¬¬ä¸€ä¸ªè´¦å·
# ç„¶ååœ¨æ•°æ®åº“é‡Œæ‰‹åŠ¨è®¾ç½®ä¸ºç®¡ç†å‘˜ï¼š
docker exec -i unlimi-db psql -U unlimi_user -d unlimi -c \
  "UPDATE users SET is_admin = true WHERE email = 'your@email.com';"
```

---

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»è¯´æ˜

### è‡ªåŠ¨åº”ç”¨è¿ç§»

ä¸¤ä¸ªéƒ¨ç½²è„šæœ¬éƒ½ä¼šè‡ªåŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š

```bash
# docker-compose.yml ä¸­é…ç½®çš„å¯åŠ¨å‘½ä»¤
command: sh -c "alembic upgrade head && python init_db.py && uvicorn app.main:app"
```

è¿™æ„å‘³ç€ï¼š
- **deploy.sh**: åº”ç”¨æ–°çš„è¿ç§»æ–‡ä»¶ï¼Œä¿ç•™ç°æœ‰æ•°æ®
- **redeploy.sh**: ä»é›¶åˆ›å»ºæ‰€æœ‰è¡¨ç»“æ„

### æ·»åŠ æ–°å­—æ®µçš„å®‰å…¨æµç¨‹

```bash
# 1. åœ¨æœ¬åœ°ä¿®æ”¹æ¨¡å‹
vim backend/app/db/models/user.py

# 2. ç”Ÿæˆè¿ç§»æ–‡ä»¶
cd backend
alembic revision --autogenerate -m "add new field"

# 3. æµ‹è¯•è¿ç§»
alembic upgrade head

# 4. æäº¤åˆ° Git
git add app/db/models/*.py alembic/versions/*.py
git commit -m "feat: add new field to user"
git push

# 5. åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²ï¼ˆä½¿ç”¨ deploy.shï¼Œä¿ç•™æ•°æ®ï¼‰
ssh root@server
cd /opt/unlimi
./deploy.sh
```

---

## ğŸ’¾ æ•°æ®å¤‡ä»½å»ºè®®

**ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…å®šæœŸå¤‡ä»½ï¼**

```bash
# æ‰‹åŠ¨å¤‡ä»½æ•°æ®åº“
docker exec unlimi-db pg_dump -U unlimi_user unlimi > backup_$(date +%Y%m%d_%H%M%S).sql

# æ¢å¤å¤‡ä»½
docker exec -i unlimi-db psql -U unlimi_user -d unlimi < backup_20231212_150000.sql

# è®¾ç½®è‡ªåŠ¨å¤‡ä»½ï¼ˆcrontabï¼‰
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * cd /opt/unlimi && docker exec unlimi-db pg_dump -U unlimi_user unlimi | gzip > /backup/unlimi_$(date +\%Y\%m\%d).sql.gz
```

---

## ğŸš¨ ç´§æ€¥æƒ…å†µå¤„ç†

### éƒ¨ç½²å¤±è´¥éœ€è¦å›æ»š

```bash
# 1. å›æ»šä»£ç 
git log  # æŸ¥çœ‹æäº¤å†å²
git checkout [ä¸Šä¸€ä¸ªæ­£å¸¸çš„ commit hash]

# 2. é‡æ–°éƒ¨ç½²
./deploy.sh
```

### æ•°æ®åº“æŸåéœ€è¦æ¢å¤

```bash
# 1. åœæ­¢æœåŠ¡
docker compose down

# 2. åˆ é™¤æŸåçš„æ•°æ®åº“
docker volume rm unlimi_postgres_data

# 3. æ¢å¤å¤‡ä»½
docker compose up -d postgres
sleep 10
docker exec -i unlimi-db psql -U unlimi_user -d unlimi < backup.sql

# 4. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d
```

---

## ğŸ“ å¸¸è§é—®é¢˜

**Q: æˆ‘åº”è¯¥ç”¨å“ªä¸ªè„šæœ¬ï¼Ÿ**
- ç”Ÿäº§ç¯å¢ƒã€æœ‰ç”¨æˆ·æ•°æ® â†’ `deploy.sh`
- å¼€å‘ç¯å¢ƒã€æƒ³æ¸…ç©ºé‡æ¥ â†’ `redeploy.sh`

**Q: æ›´æ–°ä»£ç åæ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ**
- ä½¿ç”¨ `deploy.sh` â†’ ä¸ä¼š
- ä½¿ç”¨ `redeploy.sh` â†’ ä¼š

**Q: æ–°çš„æ•°æ®åº“è¿ç§»ä¼šè‡ªåŠ¨åº”ç”¨å—ï¼Ÿ**
- æ˜¯çš„ï¼Œä¸¤ä¸ªè„šæœ¬éƒ½ä¼šè‡ªåŠ¨è¿è¡Œ `alembic upgrade head`

**Q: å¦‚ä½•æŸ¥çœ‹å½“å‰æ•°æ®åº“ç‰ˆæœ¬ï¼Ÿ**
```bash
docker exec unlimi-backend alembic current
```

**Q: å¦‚ä½•æ‰‹åŠ¨è¿è¡Œè¿ç§»ï¼Ÿ**
```bash
docker exec unlimi-backend alembic upgrade head
```
